# Test workflow for cuda-python coverage file handling pattern
# Tests the Linux/Windows coverage pattern WITHOUT building/testing (no CUDA)
# Only tests: clone, patch, file handling, and combine workflow

name: "Test: Coverage Workflow Patch"

on:
  workflow_dispatch: {}
  push:
    branches: [ test-coverage ]

env:
  PY_VER: "3.14"
  CUDA_VER: "13.1.0"

jobs:
  coverage-linux:
    name: Coverage (Linux)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout test repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VER }}

      - name: Create mock Linux coverage file
        run: |
          cat > .coverage.linux << 'EOF'
          {"lines":{"cuda/__init__.py":[1,2,3],"cuda/core/__init__.py":[1,5,10],"cuda/bindings/__init__.py":[1,3,7]}}
          EOF
          echo "Created .coverage.linux mock file"
          ls -lh .coverage.linux

      - name: Clone cuda-python repository
        run: |
          git clone https://github.com/NVIDIA/cuda-python.git
          cd cuda-python
          echo "Cloned cuda-python repository"
          git log -1 --oneline

      - name: Apply coverage patch to cuda-python
        run: |
          cd cuda-python
          git apply "$GITHUB_WORKSPACE/test.patch"
          echo "Applied test.patch"

      - name: Verify patch was applied
        run: |
          cd cuda-python
          echo "=== Verifying patch ==="
          echo "1. cuda_bindings/setup.py (build_dir):"
          grep -n 'build_dir\|COMPILE_FOR_COVERAGE' cuda_bindings/setup.py | tail -10

          echo ""
          echo "2. cuda_bindings/setup.py (package_data):"
          grep -n 'package_data\|\.cpp' cuda_bindings/setup.py | tail -10

          echo "- Patch applied successfully"

      - name: Copy Linux coverage file to cuda-python directory
        run: |
          # Verify the .coverage.linux file exists
          if [ ! -f ".coverage.linux" ]; then
            echo "ERROR: .coverage.linux not found!"
            ls -la
            exit 1
          fi
          
          # Copy to cuda-python directory
          cp .coverage.linux cuda-python/.coverage.linux
          echo "- Copied .coverage.linux to cuda-python/"
          ls -lh .coverage.linux
          ls -lh cuda-python/.coverage.linux

      - name: Create mock cuda source structure
        run: |
          cd cuda-python
          mkdir -p mock_cuda/{core,bindings,pathfinder}
          echo "# cuda/__init__.py" > mock_cuda/__init__.py
          echo "# cuda/core/__init__.py" > mock_cuda/core/__init__.py
          echo "# cuda/bindings/__init__.py" > mock_cuda/bindings/__init__.py
          echo "Mock cuda source structure created"

      - name: Upload Linux coverage data
        uses: actions/upload-artifact@v4
        with:
          name: coverage-data-linux
          path: cuda-python/.coverage.linux
          include-hidden-files: true
          if-no-files-found: error

      - name: Upload cuda source code for coverage mapping
        uses: actions/upload-artifact@v4
        with:
          name: cuda-source-linux
          path: cuda-python/mock_cuda/
          if-no-files-found: error

  build-wheel-windows:
    name: Build Wheels (Windows)
    runs-on: windows-2022
    env:
      CUDA_PYTHON_COVERAGE: "1"
    defaults:
      run:
        shell: bash --noprofile --norc -xeuo pipefail {0}
    steps:
      - name: Checkout test repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VER }}

      - name: Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Set up mini CTK
        shell: bash --noprofile --norc -xeuo pipefail {0}
        run: |
          # Fetch mini CUDA toolkit from NVIDIA redistribution CDN
          # (same approach as cuda-python/.github/actions/fetch_ctk)
          CUDA_VERSION="${{ env.CUDA_VER }}"
          CTK_BASE_URL="https://developer.download.nvidia.com/compute/cuda/redist"
          CTK_JSON_URL="${CTK_BASE_URL}/redistrib_${CUDA_VERSION}.json"
          CTK_SUBDIR="windows-x86_64"
          CUDA_PATH="$(pwd)/cuda_toolkit"
          mkdir -p "$CUDA_PATH"

          echo "Downloading mini CTK ${CUDA_VERSION} for ${CTK_SUBDIR}..."
          echo "JSON URL: ${CTK_JSON_URL}"

          # Components needed for building cuda.bindings and cuda.core
          COMPONENTS="cuda_nvcc cuda_cudart cuda_nvrtc cuda_profiler_api cuda_cccl libnvjitlink"

          # Check CUDA major version for conditional components
          CUDA_MAJOR=$(echo "$CUDA_VERSION" | cut -d'.' -f1)
          if [[ "$CUDA_MAJOR" -ge 13 ]]; then
            COMPONENTS="$COMPONENTS cuda_crt libnvvm libnvfatbin"
          fi

          for component in $COMPONENTS; do
            echo "--- Fetching ${component} ---"
            REL_PATH=$(curl -sL "$CTK_JSON_URL" | \
              python -c "import sys, json; print(json.load(sys.stdin)['${component}']['${CTK_SUBDIR}']['relative_path'])")
            COMPONENT_URL="${CTK_BASE_URL}/${REL_PATH}"
            FILENAME=$(basename "$REL_PATH")
            echo "  URL: ${COMPONENT_URL}"

            curl -kLSs "$COMPONENT_URL" -o "$FILENAME"
            # Extract zip (Windows format)
            TEMP_DIR=$(mktemp -d)
            unzip -q "$FILENAME" -d "$TEMP_DIR"
            cp -r "$TEMP_DIR"/*/* "$CUDA_PATH"/
            rm -rf "$TEMP_DIR" "$FILENAME"
            echo "  - Installed ${component}"
          done

          echo ""
          echo "=== Mini CTK contents ==="
          ls -l "$CUDA_PATH"
          ls -l "$CUDA_PATH/bin/" | head -10
          ls -l "$CUDA_PATH/include/" | head -10

          # Set CUDA_PATH for subsequent steps
          CUDA_PATH_WIN=$(cygpath -w "$CUDA_PATH")
          echo "CUDA_PATH=${CUDA_PATH_WIN}" >> $GITHUB_ENV
          echo "CUDA_HOME=${CUDA_PATH_WIN}" >> $GITHUB_ENV
          echo "$(cygpath -w "$CUDA_PATH/bin")" >> $GITHUB_PATH

      - name: Verify CUDA toolkit
        run: |
          echo "CUDA_PATH=$CUDA_PATH"
          nvcc --version || echo "nvcc not in PATH, checking CUDA_PATH..."
          ls -l "$CUDA_PATH/bin/nvcc"* 2>/dev/null || true

      - name: Clone cuda-python repository
        run: |
          git clone https://github.com/NVIDIA/cuda-python.git
          cd cuda-python
          echo "Cloned cuda-python repository"
          git log -1 --oneline

      - name: Apply coverage patch to cuda-python
        run: |
          cd cuda-python
          git apply "$GITHUB_WORKSPACE/test.patch"
          echo "Applied test.patch"

      - name: Verify patch was applied
        run: |
          cd cuda-python
          echo "=== Verifying patch ==="
          echo "1. cuda_bindings/setup.py (build_dir):"
          grep -n 'build_dir\|COMPILE_FOR_COVERAGE' cuda_bindings/setup.py | tail -10

          echo ""
          echo "2. cuda_bindings/setup.py (package_data):"
          grep -n 'package_data\|\.cpp' cuda_bindings/setup.py | tail -10

          echo "- Patch applied successfully"

      - name: Build cuda.pathfinder wheel
        run: |
          cd cuda-python
          pip install wheel setuptools
          cd cuda_pathfinder
          pip wheel -v --no-deps . -w ../wheels/
          echo "- Built cuda.pathfinder wheel"

      - name: Build cuda.bindings wheel
        run: |
          cd cuda-python
          pip install Cython
          cd cuda_bindings
          pip wheel -v --no-deps . -w ../wheels/
          echo "- Built cuda.bindings wheel"

      - name: Build cuda.core wheel
        run: |
          cd cuda-python
          export PIP_FIND_LINKS="$(pwd)/wheels"
          export PIP_PRE=1
          cd cuda_core
          pip wheel -v --no-deps . -w ../wheels/
          echo "- Built cuda.core wheel"

      - name: List all wheel artifacts
        run: |
          echo "=== Windows wheel artifacts ==="
          ls -lahR cuda-python/wheels/

      - name: Upload Windows wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-wheels
          path: cuda-python/wheels/
          if-no-files-found: error

  coverage-windows:
    name: Coverage (Windows)
    needs: [build-wheel-windows]
    runs-on: windows-latest
    env:
      CUDA_PYTHON_COVERAGE: "1"
    defaults:
      run:
        shell: bash --noprofile --norc -xeuo pipefail {0}
    steps:
      - name: Clone cuda-python repository
        run: |
          git clone https://github.com/NVIDIA/cuda-python.git
          cd cuda-python
          echo "Cloned cuda-python repository"
          git log -1 --oneline

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VER }}

      - name: Download Windows wheel artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-wheels
          path: ./wheels/

      - name: List downloaded wheel artifacts
        run: |
          echo "=== Downloaded wheel artifacts ==="
          ls -lahR ./wheels/

      - name: Create venv and install wheels
        run: |
          python -m venv .venv

          .venv/Scripts/pip install ./wheels/cuda_pathfinder*.whl
          echo "Installed cuda.pathfinder"

          .venv/Scripts/pip install ./wheels/cuda_bindings*.whl
          echo "Installed cuda.bindings"

          .venv/Scripts/pip install ./wheels/cuda_core*.whl
          echo "Installed cuda.core"

      - name: Install test dependencies and coverage tools
        run: |
          .venv/Scripts/pip install -v ./cuda-python/cuda_python_test_helpers
          .venv/Scripts/pip install coverage pytest-cov Cython
          .venv/Scripts/pip install --group ./cuda-python/cuda_bindings/pyproject.toml:test
          .venv/Scripts/pip install --group ./cuda-python/cuda_core/pyproject.toml:test

      - name: List installed cuda files
        run: |
          CUDA_PKG_DIR=$(.venv/Scripts/python -c "import cuda; print(cuda.__path__[0])")
          echo "cuda package dir: $CUDA_PKG_DIR"

          echo ""
          echo "--- .pyd files (compiled extensions) ---"
          find "$CUDA_PKG_DIR" -name "*.pyd" 2>/dev/null | sort || echo "(none)"

          echo ""
          echo "--- .cpp files (Cython generated, for coverage) ---"
          find "$CUDA_PKG_DIR" -name "*.cpp" 2>/dev/null | sort || echo "(none)"

      - name: Verify installations
        run: |
          .venv/Scripts/python -c "import cuda.pathfinder; print('cuda.pathfinder OK')"
          .venv/Scripts/python -c "import cuda.bindings; print('cuda.bindings OK')"
          .venv/Scripts/python -c "import cuda.core; print('cuda.core OK')"

      - name: Get install root
        id: install-root
        run: |
          INSTALL_ROOT=$(.venv/Scripts/python -c 'import cuda; import os; print(os.path.dirname(cuda.__path__[0]))')
          echo "INSTALL_ROOT=$INSTALL_ROOT" >> $GITHUB_OUTPUT
          echo "Install root: $INSTALL_ROOT"

      - name: Run cuda.pathfinder tests
        continue-on-error: true
        run: |
          cd "${{ steps.install-root.outputs.INSTALL_ROOT }}"
          "$GITHUB_WORKSPACE/.venv/Scripts/pytest" -v --cov=./cuda --cov-append --cov-context=test --cov-config="$GITHUB_WORKSPACE/cuda-python/.coveragerc" "$GITHUB_WORKSPACE/cuda-python/cuda_pathfinder/tests"

      - name: Run cuda.bindings tests (with 8MB stack)
        continue-on-error: true
        run: |
          cd "${{ steps.install-root.outputs.INSTALL_ROOT }}"
          "$GITHUB_WORKSPACE/.venv/Scripts/python" << 'PYTEST_EOF'
          import os
          import sys
          import threading
          import pytest

          os.chdir(r'${{ steps.install-root.outputs.INSTALL_ROOT }}')
          threading.stack_size(8 * 1024 * 1024)
          result = {'code': 1}

          def _run():
              workspace = os.environ['GITHUB_WORKSPACE']
              result['code'] = pytest.main([
                  '-v',
                  '--cov=./cuda',
                  '--cov-append',
                  '--cov-context=test',
                  f'--cov-config={workspace}/cuda-python/.coveragerc',
                  f'{workspace}/cuda-python/cuda_bindings/tests'
              ])

          t = threading.Thread(target=_run)
          t.start()
          t.join()

          print(f'Bindings tests exit code: {result["code"]}')
          sys.exit(result['code'])
          PYTEST_EOF

      - name: Run cuda.core tests
        continue-on-error: true
        run: |
          cd "${{ steps.install-root.outputs.INSTALL_ROOT }}"
          "$GITHUB_WORKSPACE/.venv/Scripts/pytest" -v --cov=./cuda --cov-append --cov-context=test --cov-config="$GITHUB_WORKSPACE/cuda-python/.coveragerc" "$GITHUB_WORKSPACE/cuda-python/cuda_core/tests"

      - name: Copy Windows coverage file to workspace
        run: |
          cp "${{ steps.install-root.outputs.INSTALL_ROOT }}/.coverage" "$GITHUB_WORKSPACE/.coverage.windows"
          echo "Copied .coverage.windows to $GITHUB_WORKSPACE"
          ls -lh "$GITHUB_WORKSPACE/.coverage.windows"

      - name: Upload Windows coverage data
        uses: actions/upload-artifact@v4
        with:
          name: coverage-data-windows
          path: .coverage.windows
          include-hidden-files: true
          if-no-files-found: error

  combine-and-report:
    name: Combine Coverage and Generate Report
    needs: [coverage-linux, coverage-windows]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VER }}

      - name: Install coverage
        run: |
          pip install coverage[toml]

      - name: Download Linux coverage data
        uses: actions/download-artifact@v4
        with:
          name: coverage-data-linux
          path: ./

      - name: Download cuda source code
        uses: actions/download-artifact@v4
        with:
          name: cuda-source-linux
          path: ./cuda/

      - name: Download Windows coverage data
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: coverage-data-windows
          path: ./

      - name: List downloaded coverage files
        run: |
          echo "=== Coverage data structure ==="
          find . -type f -name ".coverage*" -ls
          
          echo ""
          echo "=== Cuda source structure ==="
          find ./cuda -type f | head -20

      - name: Prepare coverage files for combining
        run: |
          # Create coverage-data directory structure
          mkdir -p coverage-data/linux coverage-data/windows
          
          # Move coverage files to appropriate directories
          if [ -f ".coverage.linux" ]; then
            cp .coverage.linux coverage-data/linux/.coverage
            echo "- Linux coverage data found and prepared"
            ls -lh coverage-data/linux/.coverage
          else
            echo "- Linux coverage data NOT found"
          fi
          
          if [ -f ".coverage.windows" ]; then
            cp .coverage.windows coverage-data/windows/.coverage
            echo "- Windows coverage data found and prepared"
            ls -lh coverage-data/windows/.coverage
          else
            echo "- Windows coverage data NOT found"
          fi

      - name: Test combining coverage data
        continue-on-error: true
        run: |
          # Collect all .coverage files and rename them sequentially
          i=0
          for f in ./coverage-data/linux/.coverage ./coverage-data/windows/.coverage; do
            if [ -f "$f" ]; then
              i=$((i+1))
              cp "$f" "./.coverage.$i"
              echo "Copied $f to ./.coverage.$i"
            fi
          done

          if [ "$i" -eq 0 ]; then
            echo "ERROR: no .coverage files found" >&2
            exit 1
          fi

          echo ""
          echo "=== Coverage files (staged for combine) ==="
          ls -la .coverage.*
          
          echo ""
          echo "=== Attempting to combine (may fail due to mock data) ==="
          coverage combine --keep .coverage.* || echo "Combine failed (expected with mock data)"
          
          echo ""
          echo "=== Attempting to generate report (may fail) ==="
          coverage report || echo "Report generation failed (expected with mock data)"

      - name: Summary
        run: |
          echo "=========================================="
          echo "WORKFLOW SUMMARY"
          echo "=========================================="
          echo ""
          echo "Build phase (windows-2022):"
          echo "  - Cloned cuda-python, applied Cython coverage patches"
          echo "  - Installed mini CTK from NVIDIA CDN"
          echo "  - Built real wheels (pathfinder, bindings, core) with MSVC + CTK"
          echo ""
          echo "Coverage phase (windows-latest):"
          echo "  - Downloaded and installed pre-built wheels"
          echo "  - Ran pytest with coverage for pathfinder, bindings, core"
          echo "  - Note: tests requiring GPU will fail (no GPU on windows-latest)"
          echo "=========================================="

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: workflow-test-results
          path: |
            .coverage.*
            coverage-data/
          retention-days: 7
