name: Deploy Page

on:
  push:
    branches: [main, test]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-current

      - name: Generate report
        run: |
          DATE=$(date -u +%Y-%m-%d)
          BRANCH="${{ github.ref_name }}"

          # Create deploy directory structure
          mkdir -p deploy/report/$DATE
          mkdir -p deploy/report/latest

          # Generate dated report
          cat > deploy/report/$DATE/index.html << HTMLEOF
          <!DOCTYPE html>
          <html>
          <head><title>Test Report: ${BRANCH} - ${DATE}</title></head>
          <body>
            <h1>Test Report: ${BRANCH}</h1>
            <p>Date: <strong>${DATE}</strong></p>
            <p>Branch: <strong>${BRANCH}</strong></p>
            <p>Commit: <code>${{ github.sha }}</code></p>
            <p>Time: $(date -u)</p>
          </body>
          </html>
          HTMLEOF

          # Copy as latest
          cp deploy/report/$DATE/index.html deploy/report/latest/index.html

          # Generate index page listing all historical reports
          # First, collect existing reports from gh-pages
          EXISTING_DATES=""
          if [ -d "gh-pages-current/docs/report" ]; then
            EXISTING_DATES=$(ls -d gh-pages-current/docs/report/20* 2>/dev/null | xargs -I{} basename {} | sort -r || true)
          fi

          # Build index.html
          cat > deploy/report/index.html << 'IDXHEAD'
          <!DOCTYPE html>
          <html>
          <head><title>Test Reports</title></head>
          <body>
            <h1>Test Reports</h1>
            <ul>
              <li><a href="latest/">Latest</a></li>
          IDXHEAD

          # Add current date
          echo "      <li><a href=\"$DATE/\">$DATE ($BRANCH)</a></li>" >> deploy/report/index.html

          # Add existing dates (skip if same as current)
          for d in $EXISTING_DATES; do
            if [ "$d" != "$DATE" ] && [ "$d" != "latest" ] && [ "$d" != "index.html" ]; then
              echo "      <li><a href=\"$d/\">$d</a></li>" >> deploy/report/index.html
            fi
          done

          cat >> deploy/report/index.html << 'IDXTAIL'
            </ul>
          </body>
          </html>
          IDXTAIL

          # Clean up old reports (keep last 30)
          ALL_DATES=$(echo -e "$DATE\n$EXISTING_DATES" | grep "^20" | sort -ru)
          KEEP=30
          i=0
          for d in $ALL_DATES; do
            i=$((i+1))
            if [ $i -gt $KEEP ]; then
              echo "Removing old report: $d"
              rm -rf "gh-pages-current/docs/report/$d" 2>/dev/null || true
            else
              # Preserve existing reports in deploy dir
              if [ "$d" != "$DATE" ] && [ -d "gh-pages-current/docs/report/$d" ]; then
                cp -r "gh-pages-current/docs/report/$d" "deploy/report/$d"
              fi
            fi
          done

          echo "=== Deploy structure ==="
          find deploy -type f

      - name: Deploy to gh-pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: deploy
          target-folder: docs
          clean: false
